<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‡è€…é¬¥æƒ¡é¾ï¼š99ä¹˜æ³•è©¦ç…‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-gold: #d4af37;
            --dark-bg: rgba(20, 20, 30, 0.85);
            --accent-red: #c0392b;
            --text-light: #f0f0f0;
        }

        body {
            /* é‡è¦ï¼šé€™è£¡çš„åœ–ç‰‡æª”åè¦è·Ÿæ‚¨ GitHub ä¸Šå‚³çš„ä¸€è‡´ï¼Œå»ºè­°æ”¹å› image_0.png */
            background-image: url('image_0.png'); 
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-color: #1a1a1a; /* å‚™ç”¨èƒŒæ™¯è‰² */
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-light);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        /* RPG é¢¨æ ¼å®¹å™¨é€šç”¨è¨­å®š */
        .rpg-container {
            background-color: var(--dark-bg);
            border: 4px solid var(--main-gold);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5), inset 0 0 10px rgba(0,0,0,0.8);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
            backdrop-filter: blur(5px);
        }

        h1, h2 {
            color: var(--main-gold);
            text-shadow: 2px 2px 4px #000;
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        /* --- è¨­å®šç•«é¢ (Lobby) --- */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--main-gold);
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid #555;
            border-radius: 5px;
            color: var(--text-light);
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, select:focus {
            border-color: var(--main-gold);
            outline: none;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
        }

        .radio-group label {
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: normal;
        }
        .radio-group input { margin-right: 8px; }


        /* --- éŠæˆ²æŒ‰éˆ• --- */
        .btn-epic {
            background: linear-gradient(to bottom, #e6c34d, #b38f1d);
            border: 3px solid #fff;
            color: #2c1e1e;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px #6b5412, 0 0 15px var(--main-gold);
            transition: all 0.2s;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.4);
            display: inline-block;
            margin-top: 20px;
        }

        .btn-epic:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #6b5412, 0 0 25px var(--main-gold);
        }

        .btn-epic:active {
            transform: translateY(2px);
            box-shadow: 0 1px #6b5412;
        }

        /* --- æˆ°é¬¥ç•«é¢ (Battle Screen) --- */
        #game-screen { display: none; }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 18px;
            color: #bbb;
        }
        .status-gold { color: var(--main-gold); }

        .question-box {
            font-size: 4em;
            font-weight: bold;
            margin: 30px 0;
            color: #fff;
            text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 5px 5px 10px rgba(0,0,0,0.5);
        }

        #answer-input {
            font-size: 2em;
            text-align: center;
            width: 150px;
        }

        /* ç­”å°ç­”éŒ¯çš„è¦–è¦ºæ•ˆæœ */
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .flash-green { animation: flashGreen 0.5s; }
        @keyframes flashGreen {
            0%, 100% { background-color: var(--dark-bg); }
            50% { background-color: rgba(46, 204, 113, 0.5); }
        }

        /* --- çµç®—ç•«é¢ (Result Screen) --- */
        #result-screen { display: none; z-index: 10; }
        .hero-name-display { font-size: 1.5em; color: var(--main-gold); }
        .final-score {
            font-size: 5em;
            color: var(--accent-red);
            text-shadow: 2px 2px 0 #fff, 4px 4px 0 #000;
            margin: 20px 0;
        }
        .leaderboard {
            margin-top: 30px;
            text-align: left;
            border-top: 2px solid #555;
            padding-top: 20px;
        }
        .leaderboard h3 { color: var(--main-gold); text-align: center; }
        .leaderboard ul { list-style: none; padding: 0; }
        .leaderboard li {
            padding: 10px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
        }
        .rank-1 { color: #FFD700; } /* Gold */
        .rank-2 { color: #C0C0C0; } /* Silver */
        .rank-3 { color: #CD7F32; } /* Bronze */

        /* --- ç…™ç« Canvas --- */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®“æ»‘é¼ å¯ä»¥ç©¿é€é»æ“Šä¸‹æ–¹çš„æŒ‰éˆ• */
            z-index: 5;
        }

    </style>
</head>
<body>

    <audio id="sfx-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-wrong" src="https://assets.mixkit.co/active_storage/sfx/2926/2926-preview.mp3"></audio>
    <audio id="sfx-victory" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    
    <audio id="bgm-epic" src="https://cdn.pixabay.com/audio/2023/10/24/audio_6904361690.mp3" loop preload="auto"></audio>


    <div id="setup-screen" class="rpg-container">
        <h1>âš”ï¸ å‹‡è€…è©¦ç…‰ï¼šä¹˜æ³•ä¹‹ç«  âš”ï¸</h1>
        <p>æº–å‚™å¥½é¢å°æ•¸å­—æƒ¡é¾çš„æŒ‘æˆ°äº†å—ï¼Ÿè¨­å®šä½ çš„å†’éšªï¼</p>

        <div class="form-group">
            <label for="hero-name">å‹‡è€…å§“åï¼š</label>
            <input type="text" id="hero-name" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—...">
        </div>

        <div class="form-group">
            <label for="number-select">é¸æ“‡æŒ‘æˆ°ç›®æ¨™ (ä¹˜æ•¸)ï¼š</label>
            <select id="number-select">
                <option value="2">æŒ‘æˆ° 2 çš„ä¹˜æ³•</option>
                <option value="3">æŒ‘æˆ° 3 çš„ä¹˜æ³•</option>
                <option value="4">æŒ‘æˆ° 4 çš„ä¹˜æ³•</option>
                <option value="5">æŒ‘æˆ° 5 çš„ä¹˜æ³•</option>
                <option value="6">æŒ‘æˆ° 6 çš„ä¹˜æ³•</option>
                <option value="7">æŒ‘æˆ° 7 çš„ä¹˜æ³•</option>
                <option value="8">æŒ‘æˆ° 8 çš„ä¹˜æ³•</option>
                <option value="9">æŒ‘æˆ° 9 çš„ä¹˜æ³•</option>
                <option value="all" selected>ğŸ”¥ æŒ‘æˆ°å…¨éƒ¨ (çµ‚æ¥µè©¦ç…‰)</option>
            </select>
        </div>

        <div class="form-group">
            <label>æƒ¡é¾å‡ºç¾é †åºï¼š</label>
            <div class="radio-group">
                <label><input type="radio" name="order" value="seq" checked> å¾ªåºæ¼¸é€²</label>
                <label><input type="radio" name="order" value="rev"> é€†å‘æŒ‘æˆ°</label>
                <label><input type="radio" name="order" value="rand"> éš¨æ©Ÿçªè¥²</label>
            </div>
        </div>

        <button class="btn-epic" onclick="startGame()">é–‹å§‹å†’éšªï¼(æ’­æ”¾éŸ³æ¨‚)</button>
    </div>


    <div id="game-screen" class="rpg-container">
        <div class="status-bar">
            <div>é—œå¡: <span id="progress-display" class="status-gold">1 / 10</span></div>
            <div>å¾—åˆ†: <span id="score-display" class="status-gold">0</span></div>
        </div>
        
        <div id="question-box" class="question-box">
            7 x 8 = ?
        </div>

        <div>
            <input type="text" id="answer-input" placeholder="ç­”æ¡ˆæ˜¯..." autocomplete="off">
        </div>
        
        <button class="btn-epic" style="margin-top: 30px;" onclick="checkAnswer()">ç™¼å‹•æ”»æ“Šï¼(Enter)</button>
    </div>


    <div id="result-screen" class="rpg-container">
        <h1>ğŸ† è©¦ç…‰å®Œæˆï¼ğŸ†</h1>
        <p>å‹‡è€… <span id="final-hero-name" class="hero-name-display"></span> çš„æœ€çµ‚æˆ°ç¸¾ï¼š</p>
        <div class="final-score" id="final-score-display">
            100 åˆ†
        </div>
        <p id="result-comment">å®Œç¾çš„å‹åˆ©ï¼æƒ¡é¾å·²è¢«ä½ æ“Šå€’ï¼</p>
        
        <button class="btn-epic" onclick="resetGame()">å†æ¬¡æŒ‘æˆ°</button>

        <div class="leaderboard">
            <h3>ğŸ“œ è‹±é›„æ¦œ (æœ¬æ©Ÿç´€éŒ„) ğŸ“œ</h3>
            <ul id="leaderboard-list">
                </ul>
        </div>
    </div>

    <canvas id="fireworks-canvas"></canvas>


    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let heroName = "ç„¡åå‹‡è€…";
        
        // éŸ³æ•ˆå…ƒç´ 
        const sfxCorrect = document.getElementById('sfx-correct');
        const sfxWrong = document.getElementById('sfx-wrong');
        const sfxVictory = document.getElementById('sfx-victory');
        const bgmEpic = document.getElementById('bgm-epic'); // ã€æ–°å¢ã€‘BGM

        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const ctx = fireworksCanvas.getContext('2d');

        // è¨­å®š BGM éŸ³é‡ (0.0 ~ 1.0)ï¼Œç¨å¾®å°è²ä¸€é»é¿å…è“‹ééŸ³æ•ˆ
        bgmEpic.volume = 0.4;

        // ç¶å®š Enter éµæäº¤ç­”æ¡ˆ
        document.getElementById('answer-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        });

        // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---

        function startGame() {
            // ã€æ–°å¢ã€‘é–‹å§‹æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ (ç€è¦½å™¨è¦å®šå¿…é ˆåœ¨ä½¿ç”¨è€…é»æ“Šå¾Œæ‰èƒ½æ’­æ”¾)
            bgmEpic.currentTime = 0; // å¾é ­é–‹å§‹
            bgmEpic.play().catch(error => {
                console.log("èƒŒæ™¯éŸ³æ¨‚è‡ªå‹•æ’­æ”¾è¢«ç€è¦½å™¨é˜»æ“‹ï¼Œé€™åœ¨æŸäº›è¨­å®šä¸‹æ˜¯æ­£å¸¸çš„ã€‚");
            });

            const nameInput = document.getElementById('hero-name').value.trim();
            if (nameInput) heroName = nameInput;

            const selectedNum = document.getElementById('number-select').value;
            const selectedOrder = document.querySelector('input[name="order"]:checked').value;

            // 1. ç”¢ç”Ÿé¡Œåº«
            currentQuestions = generateQuestions(selectedNum, selectedOrder);
            totalQuestions = currentQuestions.length;
            currentQuestionIndex = 0;
            score = 0;

            // 2. æ›´æ–°ä»‹é¢ä¸¦åˆ‡æ›è¢å¹•
            updateStatus();
            showQuestion();
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('answer-input').focus();
        }

        function generateQuestions(numType, orderType) {
            let questions = [];
            let multipliers = [2, 3, 4, 5, 6, 7, 8, 9];
            let multiplicands = [1, 2, 3, 4, 5, 6, 7, 8, 9];

            if (numType !== 'all') {
                multipliers = [parseInt(numType)];
            }

            for (let m1 of multipliers) {
                for (let m2 of multiplicands) {
                    questions.push({ q: `${m1} x ${m2}`, a: m1 * m2 });
                }
            }

            // æ ¹æ“šé¸æ“‡é‡æ–°æ’åº
            if (orderType === 'rev') {
                questions.reverse();
            } else if (orderType === 'rand') {
                shuffleArray(questions);
            }
            
            // å¦‚æœæ˜¯é¸å…¨éƒ¨ï¼Œé¡Œç›®å¤ªå¤šï¼Œé™åˆ¶æœ€å¤šå‡º 20 é¡Œï¼Œé¿å…å¤ªç´¯
            if (numType === 'all' && orderType === 'rand') {
                 questions = questions.slice(0, 20);
            }

            return questions;
        }

        function showQuestion() {
            if (currentQuestionIndex >= totalQuestions) {
                endGame();
                return;
            }
            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('question-box').innerText = `${q.q} = ?`;
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
        }

        function checkAnswer() {
            const input = document.getElementById('answer-input');
            const userAnswer = parseInt(input.value);
            const correctAnswer = currentQuestions[currentQuestionIndex].a;
            const gameContainer = document.getElementById('game-screen');

            if (userAnswer === correctAnswer) {
                // ç­”å°
                score += 10;
                sfxCorrect.currentTime = 0;
                sfxCorrect.play();
                gameContainer.classList.add('flash-green');
                setTimeout(() => gameContainer.classList.remove('flash-green'), 500);
            } else {
                // ç­”éŒ¯
                sfxWrong.currentTime = 0;
                sfxWrong.play();
                gameContainer.classList.add('shake');
                setTimeout(() => gameContainer.classList.remove('shake'), 500);
            }

            currentQuestionIndex++;
            updateStatus();
            
            // ç¨å¾®å»¶é²å¾Œé¡¯ç¤ºä¸‹ä¸€é¡Œï¼Œè®“ç©å®¶çœ‹åˆ°å›é¥‹
            setTimeout(showQuestion, 600);
        }

        function updateStatus() {
            document.getElementById('progress-display').innerText = `${currentQuestionIndex + 1} / ${totalQuestions}`;
            document.getElementById('score-display').innerText = score;
        }

        function endGame() {
            // ã€æ–°å¢ã€‘éŠæˆ²çµæŸï¼Œåœæ­¢èƒŒæ™¯éŸ³æ¨‚
            bgmEpic.pause();
            bgmEpic.currentTime = 0;

            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';

            document.getElementById('final-hero-name').innerText = heroName;
            document.getElementById('final-score-display').innerText = `${score} åˆ†`;

            let comment = "";
            if (score === totalQuestions * 10) {
                comment = "å‚³èªªç´šçš„è¡¨ç¾ï¼å®Œç¾çš„å‹åˆ©ï¼æƒ¡é¾å·²è¢«ä½ å¾¹åº•æ“Šå€’ï¼";
                sfxVictory.play();
                startFireworks(); // æ»¿åˆ†æ”¾ç…™ç«
            } else if (score >= totalQuestions * 8) {
                comment = "å¤ªæ£’äº†ï¼ä½ è‹±å‹‡åœ°æ“Šé€€äº†å¤§éƒ¨åˆ†çš„æ•µäººï¼";
                startFireworks(); // é«˜åˆ†æ”¾ç…™ç«
            } else {
                comment = "æˆ°é¬¥çµæŸäº†ï¼Œå‹‡è€…ã€‚é›–ç„¶æœ‰äº›æŒ«æŠ˜ï¼Œä½†ä¸‹æ¬¡ä½ ä¸€å®šæœƒæ›´å¼·ï¼";
            }
            document.getElementById('result-comment').innerText = comment;

            updateLeaderboard(heroName, score);
        }

        function resetGame() {
            // ã€æ–°å¢ã€‘ç¢ºä¿é‡ç½®æ™‚éŸ³æ¨‚ä¹Ÿæ˜¯åœæ­¢çš„
            bgmEpic.pause();
            bgmEpic.currentTime = 0;

            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'block';
            document.getElementById('hero-name').value = '';
            stopFireworks();
        }

        // --- å·¥å…·å‡½æ•¸ï¼šé™£åˆ—æ´—ç‰Œ (Fisher-Yates Shuffle) ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- æ’è¡Œæ¦œç³»çµ± (ä½¿ç”¨ LocalStorage) ---
        function updateLeaderboard(name, newScore) {
            let leaderboard = JSON.parse(localStorage.getItem('mathQuestLeaderboard')) || [];
            
            // æ–°å¢ç´€éŒ„
            leaderboard.push({ name: name, score: newScore, date: new Date().toLocaleDateString() });
            
            // æ’åº (åˆ†æ•¸é«˜åˆ°ä½)
            leaderboard.sort((a, b) => b.score - a.score);
            
            // åªä¿ç•™å‰ 5 å
            leaderboard = leaderboard.slice(0, 5);
            
            // å­˜å› LocalStorage
            localStorage.setItem('mathQuestLeaderboard', JSON.stringify(leaderboard));
            
            // æ›´æ–°ç•«é¢é¡¯ç¤º
            renderLeaderboard(leaderboard);
        }

        function renderLeaderboard(leaderboard) {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            if (leaderboard.length === 0) {
                list.innerHTML = '<li>æš«ç„¡ç´€éŒ„ï¼Œå¿«ä¾†å‰µé€ å‚³èªªï¼</li>';
                return;
            }
            leaderboard.forEach((entry, index) => {
                const li = document.createElement('li');
                let rankClass = '';
                if (index === 0) rankClass = 'rank-1';
                else if (index === 1) rankClass = 'rank-2';
                else if (index === 2) rankClass = 'rank-3';
                
                li.innerHTML = `
                    <span class="${rankClass}">No.${index + 1} ${entry.name}</span>
                    <span class="${rankClass}">${entry.score} åˆ†</span>
                `;
                list.appendChild(li);
            });
        }

        // é é¢è¼‰å…¥æ™‚å…ˆæ¸²æŸ“ä¸€æ¬¡æ’è¡Œæ¦œ
        renderLeaderboard(JSON.parse(localStorage.getItem('mathQuestLeaderboard')) || []);


        // --- ç°¡æ˜“ç…™ç«ç³»çµ± (Canvas) ---
        let particles = [];
        let fireworksActive = false;

        function resizeCanvas() {
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.velocity = {
                    x: (Math.random() - 0.5) * 8,
                    y: (Math.random() - 0.5) * 8
                };
                this.alpha = 1;
                this.friction = 0.95;
                this.gravity = 0.05;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.restore();
            }
            update() {
                this.velocity.x *= this.friction;
                this.velocity.y *= this.friction;
                this.velocity.y += this.gravity;
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.alpha -= 0.01;
            }
        }

        function createFirework(x, y) {
            const colors = ['#ff0000', '#ffd700', '#00ff00', '#00ffff', '#ff00ff'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            for (let i = 0; i < 50; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function animateFireworks() {
            if (!fireworksActive) return;
            requestAnimationFrame(animateFireworks);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; // æ‹–å½±æ•ˆæœ
            ctx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
            particles.forEach((particle, i) => {
                if (particle.alpha > 0) {
                    particle.update();
                    particle.draw();
                } else {
                    particles.splice(i, 1);
                }
            });
            // éš¨æ©Ÿç”¢ç”Ÿæ–°çš„ç…™ç«
            if (Math.random() < 0.05) {
                createFirework(Math.random() * fireworksCanvas.width, Math.random() * fireworksCanvas.height / 2);
            }
        }

        function startFireworks() {
            fireworksActive = true;
            animateFireworks();
        }

        function stopFireworks() {
            fireworksActive = false;
            ctx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
            particles = [];
        }

    </script>
</body>
</html>
