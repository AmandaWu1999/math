<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的積木乘法夥伴 (手繪底圖版)</title>
    <style>
        :root {
            --ink-color: #2c3e50;
            --highlight-color: #e67e22;
            --btn-border: 3px solid var(--ink-color);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eee; /* 最外層背景，如果圖片沒載入會看到這個 */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overflow: hidden;
        }

        #fireworks-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }

        /* --- 核心容器：設定背景圖片 --- */
        .paper-container {
            /* 這裡讀取您的圖片 bg.png */
            background-image: url('bg.png'); 
            background-size: contain; /* 讓圖片完整顯示 */
            background-repeat: no-repeat;
            background-position: center;
            
            width: 95%;
            max-width: 800px;
            /* 設定一個合適的高度比例，讓它看起來像原圖 */
            aspect-ratio: 3 / 4; 
            max-height: 90vh;
            
            position: relative;
            z-index: 10;
            /* 移除原本的邊框和背景色，因為底圖都有了 */
            background-color: transparent;
            border: none;
            box-shadow: none;

            display: flex;
            flex-direction: column;
        }

        /* --- 繪圖區域佈局調整 --- */
        .drawing-area {
            flex: 1;
            display: flex;
            padding: 20px;
            /* 這裡需要一點魔法數字來對齊底圖的位置 */
            padding-top: 18%; 
            padding-left: 8%;
            padding-right: 8%;
            gap: 2%;
        }

        .left-panel {
            flex: 0 0 16%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 5%; /* 對齊手繪按鈕位置 */
        }

        .center-panel {
            flex: 2;
            /* 移除原本的邊框和背景 */
            border: none;
            background: transparent;
            padding: 5% 8%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 8%; /* 對齊對話框 */
        }

        /* --- 元素樣式 --- */
        .question-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 5px;
        }

        .block-container {
            /* 移除虛線框，底圖有了 */
            border: none; 
            padding: 5px;
            margin: 5px 0;
        }
        .block-grid { display: grid; gap: 3px; }
        /* 積木顏色改為配合底圖的紅藍配色 */
        .block-cell {
            width: 18px; height: 18px;
            border: 2px solid var(--ink-color);
            border-radius: 2px;
        }

        .equation-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--ink-color);
            margin-top: 15px;
            white-space: nowrap;
        }
        .input-slot {
            display: inline-block; min-width: 50px;
            border-bottom: 3px solid var(--ink-color);
            text-align: center; color: var(--highlight-color);
        }

        .hand-drawn-btn {
            /* 按鈕保留白色背景，比較清楚 */
            background: white;
            border: var(--btn-border);
            border-radius: 8px;
            padding: 8px 2px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer; text-align: center;
            box-shadow: 2px 2px 0 var(--ink-color);
            transition: all 0.1s;
        }
        .hand-drawn-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        /* 對話框文字容器 (移除原本的白色氣泡背景) */
        .speech-text-container {
            width: 70%;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            color: var(--ink-color);
            /* 為了讓文字在藍色氣泡上清楚，加一點白色背景微調 */
            background: rgba(255,255,255,0.7);
            padding: 5px;
            border-radius: 10px;
            transform: rotate(-5deg); /* 配合底圖氣泡角度 */
        }
        
        /* 移除 SVG 小女孩，因為底圖有了 */
        .character-img { display: none; }

        .numpad-area {
            /* 讓鍵盤區半透明，融入背景 */
            background: rgba(238, 238, 238, 0.8);
            padding: 10px;
            border-top: 3px solid var(--ink-color);
        }
        .numpad {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 8px; max-width: 500px; margin: 0 auto;
        }
        .num-btn {
            background-color: white; border: var(--btn-border);
            border-radius: 10px; padding: 8px;
            font-size: 1.4rem; font-weight: bold;
            cursor: pointer; box-shadow: 2px 2px 0 var(--ink-color);
        }
        .num-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        #overlay-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44, 62, 80, 0.95);
            z-index: 1000; display: flex;
            flex-direction: column; justify-content: center;
            align-items: center; color: white; text-align: center;
            border-radius: 15px; /* 配合容器圓角 */
        }
    </style>
</head>
<body>

<canvas id="fireworks-canvas"></canvas>

<div class="paper-container">
    <div id="overlay-screen">
        <h1 id="overlay-title">準備好了嗎？</h1>
        <p>記得把 `bg.png` 放在旁邊喔！</p>
        <br>
        <button class="hand-drawn-btn" style="padding: 10px 30px;" onclick="startGame()">開始練習</button>
    </div>

    <div class="drawing-area">
        <div class="left-panel">
            <button class="hand-drawn-btn" style="background:#f1c40f; color:#2c3e50;" onclick="dontKnow()">[不知道]</button>
            <button class="hand-drawn-btn" style="background:#e74c3c; color:white;" onclick="quitGame()">不想<br>玩了</button>
        </div>

        <div class="center-panel">
            <div class="question-title" id="q-title">3 × 3 = ?</div>
            <div class="block-container">
                 <div class="block-grid" id="block-grid"></div>
            </div>
            <div class="equation-display">
                <span id="eq-part1">3 × 3 = </span>( <span class="input-slot" id="player-input"></span> )
            </div>
        </div>

        <div class="right-panel">
            <div class="speech-text-container" id="speech-text">快點說答案～</div>
        </div>
    </div>

    <div class="numpad-area">
         <div class="numpad">
            <button class="num-btn" onclick="addNum(1)">1</button>
            <button class="num-btn" onclick="addNum(2)">2</button>
            <button class="num-btn" onclick="addNum(3)">3</button>
            <button class="num-btn" onclick="addNum(4)">4</button>
            <button class="num-btn" onclick="addNum(5)">5</button>
            <button class="num-btn" onclick="addNum(6)">6</button>
            <button class="num-btn" onclick="addNum(7)">7</button>
            <button class="num-btn" onclick="addNum(8)">8</button>
            <button class="num-btn" onclick="addNum(9)">9</button>
            <button class="num-btn" onclick="addNum(0)">0</button>
            <button class="num-btn" style="grid-column: span 5; background:#2ecc71; color:white;" onclick="checkAnswer()">確認</button>
        </div>
    </div>
</div>

<script>
    // --- 遊戲變數 ---
    let currentNum1 = 0; let currentNum2 = 0; let correctAnswer = 0; let isGameActive = false;
    const speechBubble = document.getElementById('speech-text');

    // --- 音效系統 ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime; const gainNode = audioCtx.createGain(); gainNode.connect(audioCtx.destination);
        if (type === 'correct') {
            [523.25, 659.25, 783.99].forEach((freq, i) => { const osc = audioCtx.createOscillator(); osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, now + i * 0.1); osc.connect(gainNode); osc.start(now + i * 0.1); osc.stop(now + i * 0.1 + 0.3); });
            gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.6);
        } else if (type === 'wrong') {
            const osc = audioCtx.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.3); osc.connect(gainNode); osc.start(now); osc.stop(now + 0.3); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
        } else if (type === 'click') {
            const osc = audioCtx.createOscillator(); osc.frequency.setValueAtTime(800, now); osc.connect(gainNode); osc.start(now); osc.stop(now + 0.05); gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.05);
        }
    }

    // --- 煙火系統 ---
    const canvas = document.getElementById('fireworks-canvas'); const ctx = canvas.getContext('2d'); let particles = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function createFirework(x, y) {
        const colors = ['#e74c3c', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6'];
        for (let i = 0; i < 60; i++) { particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1, color: colors[Math.floor(Math.random() * colors.length)], size: Math.random() * 4 + 2 }); }
    }
    function animateFireworks() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life -= 0.02; ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); });
        particles = particles.filter(p => p.life > 0); requestAnimationFrame(animateFireworks);
    }
    animateFireworks();

    // --- 遊戲邏輯 ---
    function startGame() {
        document.getElementById('overlay-screen').style.display = 'none'; isGameActive = true;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        speechBubble.innerText = "快點說答案～"; generateProblem();
    }
    function quitGame() {
        isGameActive = false; document.getElementById('overlay-title').innerHTML = "下次再來玩！<br>拜拜！"; document.getElementById('overlay-screen').style.display = 'flex';
    }
    function dontKnow() {
        if (!isGameActive) return; playSound('click');
        document.getElementById('player-input').innerText = '';
        speechBubble.innerText = "[不知道的請跟我說]";
    }
    function generateProblem() {
        currentNum1 = Math.floor(Math.random() * 8) + 2; currentNum2 = Math.floor(Math.random() * 8) + 2; correctAnswer = currentNum1 * currentNum2;
        document.getElementById('q-title').innerText = `${currentNum1} × ${currentNum2} = ?`;
        document.getElementById('eq-part1').innerText = `${currentNum1} × ${currentNum2} = `;
        document.getElementById('player-input').innerText = ''; document.getElementById('player-input').style.color = "#e67e22";
        renderBlocks(currentNum1, currentNum2);
    }
    function renderBlocks(rows, cols) {
        const grid = document.getElementById('block-grid'); grid.innerHTML = ''; grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        let blockSize = 20; if (cols > 6 || rows > 6) blockSize = 16; if (cols > 8 || rows > 8) blockSize = 14;
        for (let i = 0; i < rows * cols; i++) {
            const cell = document.createElement('div'); cell.className = 'block-cell';
            cell.style.width = blockSize + 'px'; cell.style.height = blockSize + 'px';
            // 隨機分配紅藍色積木，配合底圖
            cell.style.backgroundColor = Math.random() > 0.5 ? '#e74c3c' : '#3498db';
            grid.appendChild(cell);
        }
    }
    function addNum(num) { if (!isGameActive) return; playSound('click'); const inputDiv = document.getElementById('player-input'); if (inputDiv.innerText.length < 3) inputDiv.innerText += num; }
    function checkAnswer() {
        if (!isGameActive) return; const inputDiv = document.getElementById('player-input'); const playerVal = parseInt(inputDiv.innerText);
        if (isNaN(playerVal) || inputDiv.innerText === '') { speechBubble.innerText = "你還沒輸入答案喔！"; return; }
        if (playerVal === correctAnswer) {
            playSound('correct'); createFirework(window.innerWidth / 2, window.innerHeight / 2); setTimeout(() => createFirework(window.innerWidth / 3, window.innerHeight / 2 - 50), 200); setTimeout(() => createFirework(window.innerWidth * 2 / 3, window.innerHeight / 2 - 50), 400);
            speechBubble.innerText = "哇！太厲害了！"; inputDiv.style.color = "#2ecc71";
            setTimeout(() => { speechBubble.innerText = "下一題是什麼呢？"; generateProblem(); }, 1800);
        } else {
            playSound('wrong'); speechBubble.innerText = "哎呀，再數數看？"; document.getElementById('player-input').innerText = '';
        }
    }
</script>
</body>
</html>
