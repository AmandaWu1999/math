<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ç©æœ¨ä¹˜æ³•å¤¥ä¼´</title>
    <style>
        :root {
            --ink-color: #2c3e50;
            --highlight-color: #e67e22;
            --btn-border: 3px solid var(--ink-color);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eee; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overflow: hidden;
        }

        #fireworks-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }

        .paper-container {
            /* é€™è£¡å·²ç¶“è¨­å®šå¥½è®€å–æ­£ç¢ºçš„ bg.png */
            background-image: url('bg.png'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 95%;
            max-width: 800px;
            aspect-ratio: 3 / 4; 
            max-height: 90vh;
            position: relative;
            z-index: 10;
            background-color: transparent;
            border: none;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }

        .drawing-area {
            flex: 1;
            display: flex;
            padding: 20px;
            padding-top: 18%; 
            padding-left: 8%;
            padding-right: 8%;
            gap: 2%;
        }

        .left-panel {
            flex: 0 0 16%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 5%;
        }

        .center-panel {
            flex: 2;
            border: none;
            background: transparent;
            padding: 5% 8%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 8%;
        }

        .question-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 5px;
        }

        .block-container {
            border: none; 
            padding: 5px;
            margin: 5px 0;
        }
        .block-grid { display: grid; gap: 3px; }
        .block-cell {
            width: 18px; height: 18px;
            border: 2px solid var(--ink-color);
            border-radius: 2px;
        }

        .equation-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--ink-color);
            margin-top: 15px;
            white-space: nowrap;
        }
        .input-slot {
            display: inline-block; min-width: 50px;
            border-bottom: 3px solid var(--ink-color);
            text-align: center; color: var(--highlight-color);
        }

        .hand-drawn-btn {
            background: white;
            border: var(--btn-border);
            border-radius: 8px;
            padding: 8px 2px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer; text-align: center;
            box-shadow: 2px 2px 0 var(--ink-color);
            transition: all 0.1s;
        }
        .hand-drawn-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        .speech-text-container {
            width: 70%;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            color: var(--ink-color);
            background: rgba(255,255,255,0.7);
            padding: 5px;
            border-radius: 10px;
            transform: rotate(-5deg);
        }
        
        .character-img { display: none; }

        .numpad-area {
            background: rgba(238, 238, 238, 0.8);
            padding: 10px;
            border-top: 3px solid var(--ink-color);
        }
        .numpad {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 8px; max-width: 500px; margin: 0 auto;
        }
        .num-btn {
            background-color: white; border: var(--btn-border);
            border-radius: 10px; padding: 8px;
            font-size: 1.4rem; font-weight: bold;
            cursor: pointer; box-shadow: 2px 2px 0 var(--ink-color);
        }
        .num-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        /* --- é®ç½©èˆ‡æ’è¡Œæ¦œæ¨£å¼ --- */
        .overlay-screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44, 62, 80, 0.95);
            z-index: 1000; display: flex;
            flex-direction: column; justify-content: center;
            align-items: center; color: white; text-align: center;
            border-radius: 15px;
            padding: 20px;
        }

        #name-input {
            font-size: 1.5rem; padding: 10px; border-radius: 10px; border: none;
            margin: 15px 0; text-align: center; width: 80%;
        }

        #leaderboard-list {
            list-style: none; padding: 0; width: 100%; max-height: 200px; overflow-y: auto;
            margin-bottom: 20px;
        }
        #leaderboard-list li {
            background: rgba(255,255,255,0.1); margin: 5px 0; padding: 10px;
            border-radius: 5px; display: flex; justify-content: space-between; font-size: 1.2rem;
        }
        .score-badge { font-weight: bold; color: #f1c40f; }
    </style>
</head>
<body>

<canvas id="fireworks-canvas"></canvas>

<div class="paper-container">
    <div id="start-screen" class="overlay-screen">
        <h1 style="margin: 10px 0;">æˆ‘æ˜¯ä¹˜æ³•é«˜æ‰‹</h1>
        <p>è¼¸å…¥åå­—ï¼Œè·Ÿæœ‹å‹æ¯”æ¯”çœ‹ï¼</p>
        <input type="text" id="name-input" placeholder="ä½ çš„æš±ç¨± (ä¾‹å¦‚: å°ç¾)">
        <br>
        <button class="hand-drawn-btn" style="padding: 10px 30px;" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
        <br>
        <button class="hand-drawn-btn" style="background:#3498db; color:white; margin-top:10px;" onclick="showLeaderboard()">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
    </div>

    <div id="leaderboard-screen" class="overlay-screen" style="display: none;">
        <h2 style="color:#f1c40f;">ğŸ† å‰ 10 åæ’è¡Œæ¦œ ğŸ†</h2>
        <ul id="leaderboard-list">
            <li>è¼‰å…¥ä¸­...</li>
        </ul>
        <button class="hand-drawn-btn" onclick="closeLeaderboard()">é—œé–‰</button>
    </div>

    <div id="end-screen" class="overlay-screen" style="display: none;">
        <h1 id="final-score-title">æŒ‘æˆ°çµæŸï¼</h1>
        <p id="final-score-text">ä½ çš„åˆ†æ•¸ï¼š0 åˆ†</p>
        <button id="submit-btn" class="hand-drawn-btn" style="background:#2ecc71; color:white;" onclick="submitScore()">é€å‡ºåˆ†æ•¸åˆ°æ’è¡Œæ¦œ</button>
        <br><br>
        <button class="hand-drawn-btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>


    <div class="drawing-area">
        <div class="left-panel">
            <button class="hand-drawn-btn" style="background:#f1c40f; color:#2c3e50;" onclick="dontKnow()">[ä¸çŸ¥é“]</button>
            <button class="hand-drawn-btn" style="background:#e74c3c; color:white;" onclick="endGame()">çµæŸ<br>çµç®—</button>
        </div>

        <div class="center-panel">
            <div class="question-title" id="q-title">æº–å‚™ä¸­...</div>
            <div class="block-container">
                 <div class="block-grid" id="block-grid"></div>
            </div>
            <div class="equation-display">
                <span id="eq-part1">...</span>( <span class="input-slot" id="player-input"></span> )
            </div>
        </div>

        <div class="right-panel">
            <div class="speech-text-container" id="speech-text">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
        </div>
    </div>

    <div class="numpad-area">
         <div class="numpad">
            <button class="num-btn" onclick="addNum(1)">1</button>
            <button class="num-btn" onclick="addNum(2)">2</button>
            <button class="num-btn" onclick="addNum(3)">3</button>
            <button class="num-btn" onclick="addNum(4)">4</button>
            <button class="num-btn" onclick="addNum(5)">5</button>
            <button class="num-btn" onclick="addNum(6)">6</button>
            <button class="num-btn" onclick="addNum(7)">7</button>
            <button class="num-btn" onclick="addNum(8)">8</button>
            <button class="num-btn" onclick="addNum(9)">9</button>
            <button class="num-btn" onclick="addNum(0)">0</button>
            <button class="num-btn" style="grid-column: span 5; background:#2ecc71; color:white;" onclick="checkAnswer()">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
    // =================================================================
    // ã€è¶…ç´šé‡è¦ã€‘è«‹æŠŠæ‚¨çš„ Google Script ç¶²å€è²¼åœ¨ä¸‹é¢é€™è¡Œå¼•è™Ÿè£¡ï¼
    // =================================================================
    const GOOGLE_SCRIPT_URL = "æ‚¨çš„_GOOGLE_SCRIPT_ç¶²å€_è²¼åœ¨é€™è£¡";
    // =================================================================

    let currentNum1 = 0; let currentNum2 = 0; let correctAnswer = 0; let isGameActive = false;
    let playerName = "";
    let totalScore = 0;
    const speechBubble = document.getElementById('speech-text');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime; const gainNode = audioCtx.createGain(); gainNode.connect(audioCtx.destination);
        if (type === 'correct') {
            [523.25, 659.25, 783.99].forEach((freq, i) => { const osc = audioCtx.createOscillator(); osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, now + i * 0.1); osc.connect(gainNode); osc.start(now + i * 0.1); osc.stop(now + i * 0.1 + 0.3); });
            gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.6);
        } else if (type === 'wrong') {
            const osc = audioCtx.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.3); osc.connect(gainNode); osc.start(now); osc.stop(now + 0.3); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
        } else if (type === 'click') {
            const osc = audioCtx.createOscillator(); osc.frequency.setValueAtTime(800, now); osc.connect(gainNode); osc.start(now); osc.stop(now + 0.05); gainNode.gain.setValueAtTime(0.05, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.05);
        }
    }
    const canvas = document.getElementById('fireworks-canvas'); const ctx = canvas.getContext('2d'); let particles = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function createFirework(x, y) {
        const colors = ['#e74c3c', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6'];
        for (let i = 0; i < 60; i++) { particles.push({ x: x, y: y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1, color: colors[Math.floor(Math.random() * colors.length)], size: Math.random() * 4 + 2 }); }
    }
    function animateFireworks() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life -= 0.02; ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); });
        particles = particles.filter(p => p.life > 0); requestAnimationFrame(animateFireworks);
    }
    animateFireworks();

    function startGame() {
        const nameInput = document.getElementById('name-input');
        playerName = nameInput.value.trim();
        if (playerName === "") {
            alert("è«‹å…ˆè¼¸å…¥ä½ çš„åå­—æˆ–æš±ç¨±å–”ï¼");
            return;
        }
        document.getElementById('start-screen').style.display = 'none';
        isGameActive = true; totalScore = 0;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        speechBubble.innerText = `${playerName}ï¼ŒåŠ æ²¹ï¼`; 
        generateProblem();
    }

    function endGame() {
        isGameActive = false;
        document.getElementById('final-score-text').innerText = `${playerName} çš„ç¸½åˆ†æ˜¯ï¼š${totalScore} åˆ†`;
        document.getElementById('end-screen').style.display = 'flex';
    }

    function dontKnow() {
        if (!isGameActive) return; playSound('click');
        document.getElementById('player-input').innerText = '';
        speechBubble.innerText = "[ä¸çŸ¥é“çš„è«‹è·Ÿæˆ‘èªª]";
    }
    function generateProblem() {
        currentNum1 = Math.floor(Math.random() * 8) + 2; currentNum2 = Math.floor(Math.random() * 8) + 2; correctAnswer = currentNum1 * currentNum2;
        document.getElementById('q-title').innerText = `${currentNum1} Ã— ${currentNum2} = ?`;
        document.getElementById('eq-part1').innerText = `${currentNum1} Ã— ${currentNum2} = `;
        document.getElementById('player-input').innerText = ''; document.getElementById('player-input').style.color = "#e67e22";
        renderBlocks(currentNum1, currentNum2);
    }
    function renderBlocks(rows, cols) {
        const grid = document.getElementById('block-grid'); grid.innerHTML = ''; grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        let blockSize = 20; if (cols > 6 || rows > 6) blockSize = 16; if (cols > 8 || rows > 8) blockSize = 14;
        for (let i = 0; i < rows * cols; i++) {
            const cell = document.createElement('div'); cell.className = 'block-cell';
            cell.style.width = blockSize + 'px'; cell.style.height = blockSize + 'px';
            cell.style.backgroundColor = Math.random() > 0.5 ? '#e74c3c' : '#3498db';
            grid.appendChild(cell);
        }
    }
    function addNum(num) { if (!isGameActive) return; playSound('click'); const inputDiv = document.getElementById('player-input'); if (inputDiv.innerText.length < 3) inputDiv.innerText += num; }
    
    function checkAnswer() {
        if (!isGameActive) return; const inputDiv = document.getElementById('player-input'); const playerVal = parseInt(inputDiv.innerText);
        if (isNaN(playerVal) || inputDiv.innerText === '') { speechBubble.innerText = "ä½ é‚„æ²’è¼¸å…¥ç­”æ¡ˆå–”ï¼"; return; }
        if (playerVal === correctAnswer) {
            playSound('correct'); createFirework(window.innerWidth / 2, window.innerHeight / 2); setTimeout(() => createFirework(window.innerWidth / 3, window.innerHeight / 2 - 50), 200); setTimeout(() => createFirework(window.innerWidth * 2 / 3, window.innerHeight / 2 - 50), 400);
            
            totalScore += 10;
            speechBubble.innerText = `ç­”å°äº†ï¼ç›®å‰ ${totalScore} åˆ†`;
            inputDiv.style.color = "#2ecc71";
            setTimeout(() => { speechBubble.innerText = "ä¸‹ä¸€é¡Œï¼"; generateProblem(); }, 1800);
        } else {
            playSound('wrong'); speechBubble.innerText = "å“å‘€ï¼Œå†æ•¸æ•¸çœ‹ï¼Ÿ"; document.getElementById('player-input').innerText = '';
        }
    }

    function submitScore() {
        if (GOOGLE_SCRIPT_URL === "æ‚¨çš„_GOOGLE_SCRIPT_ç¶²å€_è²¼åœ¨é€™è£¡" || GOOGLE_SCRIPT_URL === "") {
            alert("è«‹å…ˆè¨­å®š Google Script ç¶²å€ï¼"); return;
        }
        const btn = document.getElementById('submit-btn');
        btn.innerText = "é€å‡ºä¸­..."; btn.disabled = true;

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ name: playerName, score: totalScore })
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === "success") {
                alert("åˆ†æ•¸é€å‡ºæˆåŠŸï¼ä¾†çœ‹çœ‹æ’è¡Œæ¦œå§ï¼");
                document.getElementById('end-screen').style.display = 'none';
                showLeaderboard();
            } else {
                alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); btn.innerText = "é€å‡ºåˆ†æ•¸åˆ°æ’è¡Œæ¦œ"; btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•é€£ç·šåˆ°æ’è¡Œæ¦œä¼ºæœå™¨ã€‚");
             btn.innerText = "é€å‡ºåˆ†æ•¸åˆ°æ’è¡Œæ¦œ"; btn.disabled = false;
        });
    }

    function showLeaderboard() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('leaderboard-screen').style.display = 'flex';
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '<li>æ­£åœ¨è®€å–æœ€æ–°æ’å...</li>';

        if (GOOGLE_SCRIPT_URL === "æ‚¨çš„_GOOGLE_SCRIPT_ç¶²å€_è²¼åœ¨é€™è£¡" || GOOGLE_SCRIPT_URL === "") {
            list.innerHTML = '<li>å°šæœªè¨­å®šæ’è¡Œæ¦œé€£çµã€‚</li>'; return;
        }

        fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = '<li>ç›®å‰é‚„æ²’æœ‰äººä¸Šæ¦œå–”ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€åï¼</li>';
            } else {
                data.forEach((row, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${index + 1}. ${row[0]}</span> <span class="score-badge">${row[1]} åˆ†</span>`;
                    list.appendChild(li);
                });
            }
        })
        .catch(error => {
             console.error('Error:', error);
             list.innerHTML = '<li>è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</li>';
        });
    }

    function closeLeaderboard() {
        document.getElementById('leaderboard-screen').style.display = 'none';
        if (playerName === "") {
             document.getElementById('start-screen').style.display = 'flex';
        }
    }
</script>
</body>
</html>
